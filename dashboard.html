<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - CompuFix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">CompuFix</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="services.html">Servicios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="services-details.html">Detalles</a>
                    </li>
                    <li class="nav-item">
                       <a class="nav-link" href="referral.html">Referidos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact.html">Contacto</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="coment.html">Comentarios</a>
                    </li>
                    <li class="nav-item" id="profileNavItem" style="display: none;">
                        <a class="nav-link" href="dashboard.html">Mi Perfil</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light" id="logoutBtn">Cerrar Sesión</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5" id="dashboardContent" style="display: none;">
        <div class="row">
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <img src="https://ui-avatars.com/api/?name=Usuario&background=random" alt="Avatar" class="rounded-circle img-fluid" style="width: 150px;">
                        <h5 class="my-3" id="userName"></h5>
                        <p class="text-muted mb-1" id="userEmail"></p>
                        <div class="d-flex justify-content-center mb-2">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">Editar Perfil</button>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Tus Referidos</h5>
                        <div id="referralDetails">
                            <p>Cargando estadísticas...</p>
                        </div>
                        <a href="referral.html" class="btn btn-sm btn-primary mt-2">Gestionar Referidos</a>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Información de Contacto</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center p-0 py-2">
                                <span class="mb-0">Teléfono:</span>
                                <span class="text-muted" id="userPhone">No especificado</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center p-0 py-2">
                                <span class="mb-0">Dirección:</span>
                                <span class="text-muted" id="userAddress">No especificada</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Mis Servicios Solicitados</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Servicio</th>
                                        <th>Tipo</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="serviceRequestsTable">
                                    <!-- Aquí se cargarán las solicitudes -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Solicitar Nuevo Servicio</h5>
                        <p>¿Necesitas ayuda con tu equipo? Solicita uno de nuestros servicios.</p>
                        <a href="services.html" class="btn btn-primary">Ver Servicios</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar perfil -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="editName" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="editPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editAddress" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="editAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveProfileBtn">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar cancelación de servicio -->
    <div class="modal fade" id="cancelServiceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Cancelación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro que deseas cancelar este servicio?</p>
                    <input type="hidden" id="serviceToCancel">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, mantener</button>
                    <button type="button" class="btn btn-danger" id="confirmCancelBtn">Sí, cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Contacto</h5>
                    <p>Santa Tecla, La Libertad, El Salvador</p>
                    <p>Email: info@compufix.com</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <h5>Horario</h5>
                    <p>Lunes a Viernes: 9:00 AM - 6:00 PM</p>
                    <p>Sábados: 9:00 AM - 12:00 PM</p>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p>&copy; 2025 CompuFix. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/fileStorage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/services.js"></script>
    <script>
        
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar sesión
        const userData = sessionStorage.getItem('currentUser');
    
        if (!userData) {
            window.location.href = 'login.html';
            return;
        }
        
        // Mostrar contenido del dashboard y opción de perfil en el navbar
        document.getElementById('dashboardContent').style.display = 'block';
        document.getElementById('profileNavItem').style.display = 'block';
        
        const user = JSON.parse(userData);
    
        // Mostrar datos del usuario
        document.getElementById('userName').textContent = user.name || 'Usuario';
        document.getElementById('userEmail').textContent = user.email || 'usuario@ejemplo.com';
        document.getElementById('userPhone').textContent = user.phone || 'No especificado';
        document.getElementById('userAddress').textContent = user.address || 'No especificada';
        
        // Rellenar formulario de edición
        document.getElementById('editName').value = user.name || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editPhone').value = user.phone || '';
        document.getElementById('editAddress').value = user.address || '';
        
        // Cargar solicitudes de servicio
        loadServiceRequests(user.email);
        
        // Configurar evento de cierre de sesión
        document.getElementById('logoutBtn').addEventListener('click', function() {
            sessionStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        });
        
        // Guardar cambios del perfil
        document.getElementById('saveProfileBtn').addEventListener('click', function() {
            const updatedUser = {
                ...user,
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                address: document.getElementById('editAddress').value
            };
            
            // Actualizar en sessionStorage
            sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
            
            // Actualizar la vista
            document.getElementById('userName').textContent = updatedUser.name;
            document.getElementById('userEmail').textContent = updatedUser.email;
            document.getElementById('userPhone').textContent = updatedUser.phone || 'No especificado';
            document.getElementById('userAddress').textContent = updatedUser.address || 'No especificada';
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
            modal.hide();
            
            alert('Perfil actualizado correctamente');
        });
        
        // Confirmar cancelación de servicio
        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            const serviceId = parseInt(document.getElementById('serviceToCancel').value);
            const serviceRequests = JSON.parse(localStorage.getItem('compufix_serviceRequests') || '[]');
            const userData = JSON.parse(sessionStorage.getItem('currentUser'));
            
            if (serviceId >= 0 && serviceId < serviceRequests.length && 
                serviceRequests[serviceId].userEmail === userData.email) {
                
                serviceRequests[serviceId].status = 'Cancelado';
                localStorage.setItem('compufix_serviceRequests', JSON.stringify(serviceRequests));
                
                // Recargar la tabla
                loadServiceRequests(userData.email);
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('cancelServiceModal'));
                modal.hide();
                
                alert('Servicio cancelado correctamente');
            } else {
                alert('Error al cancelar el servicio');
            }
        });
    });
    
    function loadServiceRequests(userEmail) {
        const serviceRequests = JSON.parse(localStorage.getItem('compufix_serviceRequests') || '[]');
        const userRequests = serviceRequests.filter(req => req.userEmail === userEmail);
        const tableBody = document.getElementById('serviceRequestsTable');
        
        tableBody.innerHTML = '';
        
        if (userRequests.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No hay servicios solicitados</td></tr>';
            return;
        }
        
        userRequests.forEach((request, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${request.service}</td>
                <td>${getServiceTypeName(request.serviceType)}</td>
                <td>${new Date(request.preferredDate).toLocaleDateString()}</td>
                <td><span class="badge ${getStatusBadgeClass(request.status)}">${request.status}</span></td>
                <td>
                    ${request.status === 'Pendiente' ? 
                        `<button class="btn btn-sm btn-danger cancel-btn" data-id="${index}">Cancelar</button>` : 
                        '<span class="text-muted">No aplica</span>'}
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        // Configurar eventos para botones de cancelar
        document.querySelectorAll('.cancel-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const serviceId = this.getAttribute('data-id');
                document.getElementById('serviceToCancel').value = serviceId;
                const modal = new bootstrap.Modal(document.getElementById('cancelServiceModal'));
                modal.show();
            });
        });
    }
    
    function getServiceTypeName(type) {
        const types = {
            'online': 'Soporte Remoto',
            'taller': 'En Taller',
            'domicilio': 'A Domicilio'
        };
        return types[type] || type;
    }
    
    function getStatusBadgeClass(status) {
        const classes = {
            'Pendiente': 'bg-warning',
            'En Proceso': 'bg-info',
            'Completado': 'bg-success',
            'Cancelado': 'bg-danger'
        };
        return classes[status] || 'bg-secondary';
    }
    function loadReferralDetails(email) {
    const referrals = JSON.parse(localStorage.getItem('compufix_referrals')) || {};
    const userReferrals = referrals[email] || { total: 0, byService: {}, completed: 0, savings: 0 };
    
    let detailsHTML = `
        <p><strong>Total referidos:</strong> ${userReferrals.total}</p>
        <p><strong>Servicios completados:</strong> ${userReferrals.completed}</p>
        <p><strong>Ahorros generados:</strong> $${userReferrals.savings.toFixed(2)}</p>
        <h6 class="mt-3">Por servicio:</h6>
        <ul class="list-group list-group-flush">
    `;
    
    for (const [service, count] of Object.entries(userReferrals.byService)) {
        detailsHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center p-0 py-2">
                <span>${getServiceName(service)}</span>
                <span class="badge bg-primary rounded-pill">${count}</span>
            </li>
        `;
    }
    
    detailsHTML += `</ul>`;
    document.getElementById('referralDetails').innerHTML = detailsHTML;
}

function getServiceName(serviceKey) {
    const services = {
        'all': 'Todos los servicios',
        'repair': 'Reparación de hardware',
        'software': 'Instalación de software',
        'virus': 'Limpieza de virus',
        'backup': 'Recuperación de datos',
        'upgrade': 'Actualización de equipo'
    };
    return services[serviceKey] || serviceKey;
}

// Llamar a la función cuando se cargue el dashboard
document.addEventListener('DOMContentLoaded', function() {
    const userData = JSON.parse(sessionStorage.getItem('currentUser'));
    if (userData) {
        loadReferralDetails(userData.email);
    }
});
    </script>
</body>
</html>